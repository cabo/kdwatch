#!/usr/bin/env ruby
ENV["LANG"]="en_US.utf-8"
ENV["LC_CTYPE"]="en_US.utf-8"
ENV["KRAMDOWN_PERSISTENT"]="yes"

if ARGV == []
   ARGV.replace Dir.glob(["draft-*.md", "*.mkd"])
   warn_replace = 1
end

if ARGV.size != 1
   warn "** Usage: #$0 [-r] [draft-foo.md]"
   warn "**        #$0 -e"
   if warn_replace
     if ARGV.size > 1
       warn "**   More than one draft file found #{ARGV.inspect}"
       warn "**   Please select one for watching."
     else
       warn "**   No draft file draft-*.md or *.mkd found."
     end
   end
   exit 1
end

ENV["KD_WATCH_SRC"] = ARGV[0]

File.write(".config.ru", <<HERE)
require 'rack-livereload'
use Rack::LiveReload, min_delay: 500, source: :vendored, no_swf: true
require 'kdwatch-app.rb'
run Sinatra::Application
HERE

exec("rackup -E production -s thin -p 7991 .config.ru")
